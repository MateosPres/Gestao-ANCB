<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal ANCB-MT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --cor-vermelho-escuro: #A62626; --cor-vermelho-claro: #D92E2E; --cor-azul-escuro: #0D47A1; --cor-azul-claro: #1976D2; --cor-laranja: #F27405; --cor-preto: #1A1A1A; --cor-cinza-fundo: #f0f2f5; --cor-cinza-texto: #333; --cor-branco: #ffffff; --sombra-card: 0 4px 12px rgba(0,0,0,0.1); --sombra-card-hover: 0 8px 20px rgba(0,0,0,0.15); --fonte-titulo: 'Roboto', sans-serif; --cor-sucesso: #28a745; --cor-aviso: #ffc107; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--cor-cinza-fundo); color: var(--cor-cinza-texto); line-height: 1.6; background-image: url('bg.jpg'); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; }
        body.modal-open { overflow: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .auth-container { display: none; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; }
        .auth-container.active { display: flex; }
        .auth-box { width: 100%; max-width: 400px; padding: 40px; background: var(--cor-branco); box-shadow: var(--sombra-card); border-radius: 12px; text-align: center; position: relative; }
        .login-logo { height: 90px; width: auto; display: block; margin: 0 auto 20px; }
        .auth-box h2 { font-family: var(--fonte-titulo); font-size: 2.5rem; margin-bottom: 25px; color: var(--cor-preto); }
        .auth-error { color: var(--cor-vermelho-escuro); margin-top: 15px; display: none; }
        .auth-toggle-link { margin-top: 20px; font-size: 0.9rem; color: var(--cor-azul-claro); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .form-group label.inline-label { text-align: left; display: block; margin-bottom: 5px; font-weight: 600; }
        .nav-tabs { display: flex; margin-bottom: 0; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border-radius: 8px 8px 0 0; padding: 5px 5px 0 5px; }
        .nav-tab { padding: 10px 20px; cursor: pointer; font-size: 1.1rem; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .nav-tab:hover { color: var(--cor-azul-escuro); }
        .nav-tab.active { color: var(--cor-azul-escuro); border-bottom-color: var(--cor-azul-escuro); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .site-header { background: linear-gradient(135deg, var(--cor-azul-escuro), var(--cor-preto)); color: var(--cor-branco); padding: 10px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header-container { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { height: 60px; width: auto; border-radius: 8px; }
        .site-header h1 { font-family: var(--fonte-titulo); font-size: 2.8rem; letter-spacing: 1px; margin: 0; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        #welcome-message { font-weight: 600; font-size: 1rem; }
        .site-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: var(--cor-preto); color: var(--cor-branco); }
        .content-section { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.2); margin-top: 0; border-radius: 0 0 12px 12px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-bottom: 2px solid var(--cor-cinza-fundo); padding-bottom: 15px; margin-bottom: 25px; }
        .section-header h2 { font-family: var(--fonte-titulo); font-size: 2.5rem; color: var(--cor-preto); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; }
        .btn { padding: 10px 20px; font-size: 0.95rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; gap: 8px; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn[disabled] { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--cor-laranja); color: var(--cor-branco); }
        .btn-secondary { background-color: var(--cor-azul-claro); color: var(--cor-branco); }
        .btn-logout { background-color: var(--cor-vermelho-claro); color: var(--cor-branco); }
        .admin-only, .logged-in-only, .logged-out-only { display: none; }
        #admin-users-table-wrapper { display: block; overflow-x: auto; }
        #admin-users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #admin-users-table th, #admin-users-table td { padding: 12px; border: 1px solid #ddd; text-align: left; white-space: nowrap; }
        #admin-users-table th { background-color: var(--cor-cinza-fundo); }
        .user-actions { display: flex; gap: 8px; align-items: center;}
        .action-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .action-btn:hover { opacity: 0.7; }
        .btn-delete { color: var(--cor-vermelho-escuro); }
        .btn-ban { color: var(--cor-laranja); }
        .btn-unban { color: var(--cor-sucesso); }
        .role-toggle { padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; color: white; font-size: 0.8rem;}
        .role-toggle.admin { background-color: var(--cor-sucesso); }
        .role-toggle.jogador { background-color: var(--cor-aviso); color: var(--cor-preto); }
        .role-toggle[disabled] { background-color: #aaa; cursor: not-allowed; }
        .user-status.banned { color: var(--cor-vermelho-escuro); font-weight: bold; }
        .player-card, .championship-card { background-color: var(--cor-branco); border-radius: 12px; box-shadow: var(--sombra-card); text-align: center; padding: 20px; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; overflow: hidden; border: 1px solid #e2e8f0; padding-bottom: 50px; }
        .player-card:hover, .championship-card:hover { transform: translateY(-5px); box-shadow: var(--sombra-card-hover); }
        .player-card .photo-container { width: 120px; height: 120px; margin: 0 auto 15px; border-radius: 50%; overflow: hidden; background-color: var(--cor-cinza-fundo); display: flex; align-items: center; justify-content: center; border: 4px solid var(--cor-branco); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .player-card .photo-container img { width: 100%; height: 100%; object-fit: cover; }
        .player-card .photo-placeholder { font-size: 3rem; color: var(--cor-laranja); }
        .player-card .player-name { font-weight: 600; font-size: 1.2rem; color: var(--cor-preto); }
        .championship-card { text-align: left; }
        .championship-card::after { content: 'üèÜ'; position: absolute; right: -20px; top: -10px; font-size: 6rem; color: var(--cor-laranja); opacity: 0.1; transform: rotate(-15deg); }
        .championship-card .championship-name { font-size: 1.5rem; font-weight: bold; color: var(--cor-azul-escuro); margin-bottom: 10px; }
        .championship-card .championship-info p { margin: 4px 0; color: #555; }
        .card-actions { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 8px; background: none; backdrop-filter: none; padding: 0; border-radius: 0; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 5; }
        .player-card:not(.admin-view):hover .card-actions, .championship-card:not(.admin-view):hover .card-actions { opacity: 1; }
        .card.admin-view .card-actions { opacity: 1; }
        .card-actions button { font-size: 1.1rem; padding: 8px; border: none; border-radius: 50%; width: 36px; height: 36px; line-height: 1; color: var(--cor-cinza-texto); background-color: var(--cor-cinza-fundo); cursor: pointer; transition: background-color 0.2s, color 0.2s, transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .card-actions button:hover { background-color: var(--cor-azul-claro); color: var(--cor-branco); transform: translateY(-2px); }
        .modal-backdrop { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal { display: none; position: fixed; z-index: 1001; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; animation: slideDown 0.3s ease-out; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from { transform: translate(-50%, -60%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
        .modal.active, .modal-backdrop.active { display: block; }
        .close-button { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; border: none; background: none; z-index: 10; color: #555;}
        .close-button:hover { color: var(--cor-vermelho-claro); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        #preview-foto { max-width: 100px; height: 100px; object-fit: cover; border-radius: 50%; display: none; margin-top: 10px; }
        #preview-foto.visible { display: block; }
        #lista-jogadores-escalar { max-height: 300px; overflow-y: auto; border: 1px solid #eee; background-color: #fcfcfc; padding: 5px; border-radius: 8px; }
        .checkbox-item { display: flex; align-items: center; padding: 10px 15px; margin-bottom: 5px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s; }
        .checkbox-item:hover { background-color: #f5f5f5; }
        .checkbox-item input[type="checkbox"] { margin-right: 15px; width: 1.3em; height: 1.3em; cursor: pointer; }
        .checkbox-item span { flex-grow: 1; }
        #ficha-jogador { display: flex; gap: 20px; align-items: center; }
        #ficha-jogador img, #ficha-jogador .placeholder { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .placeholder { background-color: var(--cor-cinza-fundo); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--cor-laranja); }
        #escalacao-container { max-height: 40vh; overflow-y: auto; margin-top: 20px; }
        .jogador-escalado { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .jogador-escalado img, .jogador-escalado .placeholder { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        @media screen and (max-width: 768px) { .container { padding: 10px; } .header-container { flex-wrap: wrap; justify-content: center; gap: 10px;} .header-left { order: 1; } .header-right { order: 2; width: 100%; justify-content: center;} .logo { height: 40px; } .site-header h1 { font-size: 1.5rem; text-align: center; } #welcome-message { font-size: 0.8rem; text-align: right; } .btn-logout { padding: 8px 12px; } .nav-tabs { justify-content: space-around; } .nav-tab { padding: 8px 10px; font-size: 0.9rem; text-align: center; flex-grow: 1;} .section-header { flex-direction: column; align-items: flex-start; gap: 10px; } .section-header h2 { font-size: 2rem; } .content-section { padding: 15px; } .card-grid { grid-template-columns: 1fr; gap: 20px; } .modal-content { padding: 20px; } #ficha-jogador { flex-direction: column; } .auth-box { padding: 20px; } .auth-box h2 { font-size: 2rem; } .card-actions { bottom: 5px; right: 5px; } .card-actions button { width: 30px; height: 30px; font-size: 1rem; padding: 5px; } }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container header-container">
            <div class="header-left"> <img src="Escudo ABNC.png" alt="Escudo ANCB-MT" class="logo"> <h1>Portal ANCB-MT</h1> </div>
            <div class="header-right">
                <div class="logged-in-only"> <span id="welcome-message"></span> <button id="btn-logout" class="btn btn-logout btn-sm">Sair</button> </div>
                <div class="logged-out-only"> <button id="btn-show-login" class="btn btn-secondary btn-sm">Login</button> <button id="btn-show-register" class="btn btn-primary btn-sm">Registrar</button> </div>
            </div>
        </div>
    </header>
    <main class="container">
        <nav class="nav-tabs">
            <div class="nav-tab active" data-tab="campeonatos">Campeonatos</div>
            <div class="nav-tab" data-tab="jogadores">Jogadores</div>
            <div class="nav-tab admin-only" data-tab="admin">Administradores</div>
        </nav>
        <div id="tab-campeonatos" class="tab-content active"> <section class="content-section"> <div class="section-header"> <h2>Campeonatos</h2> <button id="btn-abrir-modal-campeonato" class="btn btn-primary admin-only">üèÜ Adicionar Campeonato</button> </div> <div id="grid-campeonatos" class="card-grid"></div> </section> </div>
        <div id="tab-jogadores" class="tab-content"> <section class="content-section"> <div class="section-header"> <h2>Jogadores</h2> <button id="btn-abrir-modal-jogador" class="btn btn-primary admin-only">‚ûï Cadastrar Jogador</button> </div> <div id="grid-jogadores" class="card-grid"></div> </section> </div>
        <div id="tab-admin" class="tab-content"> <section class="content-section"> <div class="section-header"> <h2>Gerenciar Usu√°rios</h2> </div> <div id="admin-users-table-wrapper"> <table id="admin-users-table"> <thead> <tr> <th>Email</th> <th>Nome</th> <th>Status</th> <th>Permiss√£o</th> <th>A√ß√µes</th> </tr> </thead> <tbody id="users-table-body"></tbody> </table> </div> </section> </div>
    </main>
    <footer class="site-footer"> <p>&copy; 2025 ANCB-MT. Todos os direitos reservados.</p> </footer>
    <div id="login-container" class="auth-container"> <div class="auth-box"> <button class="close-button" aria-label="Fechar">&times;</button> <img src="Escudo ABNC.png" alt="Escudo ANCB-MT" class="login-logo"> <h2>ANCB-MT Login</h2> <form id="login-form"> <div class="form-group"> <input type="email" id="login-email" placeholder="Email" required> </div> <div class="form-group"> <input type="password" id="login-password" placeholder="Senha" required> </div> <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button> <p id="login-error" class="auth-error">Email ou senha inv√°lidos.</p> </form> <p id="toggle-to-register" class="auth-toggle-link">N√£o tem uma conta? Registre-se</p> </div> </div>
    <div id="register-container" class="auth-container"> <div class="auth-box"> <button class="close-button" aria-label="Fechar">&times;</button> <img src="Escudo ABNC.png" alt="Escudo ANCB-MT" class="login-logo"> <h2>Criar Conta</h2> <form id="register-form"> <div class="form-group"> <input type="text" id="register-nome" placeholder="Nome Completo" required> </div> <div class="form-group"> <input type="text" id="register-apelido" placeholder="Apelido" required> </div> <div class="form-group"> <label for="register-nascimento" class="inline-label">Data de Nascimento</label> <input type="date" id="register-nascimento" required> </div> <div class="form-group"> <input type="email" id="register-email" placeholder="Email" required> </div> <div class="form-group"> <input type="password" id="register-password" placeholder="Senha (m√≠nimo 6 caracteres)" required> </div> <div class="form-group"> <input type="password" id="register-password-confirm" placeholder="Confirmar Senha" required> </div> <button type="submit" class="btn btn-primary" style="width: 100%;">Registrar</button> <p id="register-error" class="auth-error">Ocorreu um erro.</p> </form> <p id="toggle-to-login" class="auth-toggle-link">J√° tem uma conta? Fa√ßa o login</p> </div> </div>
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="modal-jogador" class="modal"><div class="modal-content"><button class="close-button" aria-label="Fechar">&times;</button><h2 id="modal-jogador-titulo"></h2><form id="form-jogador"><input type="hidden" id="documento-id"><div class="form-group"><label for="foto">Foto de Perfil</label><input type="file" id="foto" accept="image/*"><img id="preview-foto" src="" alt="Pr√©-visualiza√ß√£o da foto"></div><div class="form-group"><label for="nome">Nome Completo</label><input type="text" id="nome" required></div><div class="form-group"><label for="cpf">CPF</label><input type="text" id="cpf" required></div><div class="form-group"><label for="nascimento">Data de Nascimento</label><input type="date" id="nascimento" required></div><div class="form-group"><label for="posicao">Posi√ß√£o</label><select id="posicao" required><option value="">Selecione...</option><option value="Armador (PG)">Armador (PG)</option><option value="Ala-Armador (SG)">Ala-Armador (SG)</option><option value="Ala (SF)">Ala (SF)</option><option value="Ala-Piv√¥ (PF)">Ala-Piv√¥ (PF)</option><option value="Piv√¥ (C)">Piv√¥ (C)</option></select></div><div class="form-group"><label for="numero_uniforme">N¬∫ Uniforme</label><input type="number" id="numero_uniforme" min="0" required></div><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    <div id="modal-ver-jogador" class="modal"><div class="modal-content"><button class="close-button" aria-label="Fechar">&times;</button><h2>Ficha do Jogador</h2><div id="ficha-jogador"></div></div></div>
    <div id="modal-campeonato" class="modal"><div class="modal-content"><button class="close-button" aria-label="Fechar">&times;</button><h2 id="modal-campeonato-titulo"></h2><form id="form-campeonato"><input type="hidden" id="campeonato-id"><div class="form-group"><label for="campeonato-nome">Nome do Campeonato</label><input type="text" id="campeonato-nome" required></div><div class="form-group"><label for="campeonato-data">Data</label><input type="date" id="campeonato-data" required></div><div class="form-group"><label>Escalar Jogadores</label><div id="lista-jogadores-escalar"></div></div><button type="submit" class="btn btn-primary">Salvar Campeonato</button></form></div></div>
    <div id="modal-ver-campeonato" class="modal"><div class="modal-content"><button class="close-button" aria-label="Fechar">&times;</button><h2 id="ver-campeonato-titulo"></h2><p id="ver-campeonato-data"></p><hr><h3>Jogadores Escalados</h3><div id="escalacao-container"></div></div></div>
    <div id="modal-edit-user" class="modal"><div class="modal-content"><button class="close-button" aria-label="Fechar">&times;</button><h2 id="modal-edit-user-titulo">Editar Usu√°rio</h2><form id="form-edit-user"><input type="hidden" id="edit-user-id"><div class="form-group"><label for="edit-user-nome">Nome Completo</label><input type="text" id="edit-user-nome" required></div><div class="form-group"><label for="edit-user-apelido">Apelido</label><input type="text" id="edit-user-apelido" required></div><div class="form-group"><label for="edit-user-nascimento">Data de Nascimento</label><input type="date" id="edit-user-nascimento" required></div><button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button></form></div></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCZ2yeJJ34VwYAmQnFCEv72Q1uDFFGKKjQ", authDomain: "ancb-painel-db.firebaseapp.com", projectId: "ancb-painel-db", storageBucket: "ancb-painel-db.appspot.com", messagingSenderId: "792900234002", appId: "1:792900234002:web:2a37004deb046cb8f261cb", measurementId: "G-VCMEKP1XP4" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let state = { jogadores: [], campeonatos: [], allUsers: [], currentUser: null, currentUserProfile: null, userRole: null, listeners: {} };

        const elements = {
            body: document.body, loginContainer: document.getElementById('login-container'), registerContainer: document.getElementById('register-container'),
            loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'),
            loginError: document.getElementById('login-error'), registerError: document.getElementById('register-error'), toggleToRegister: document.getElementById('toggle-to-register'),
            toggleToLogin: document.getElementById('toggle-to-login'), btnLogout: document.getElementById('btn-logout'), welcomeMessage: document.getElementById('welcome-message'),
            gridJogadores: document.getElementById('grid-jogadores'), gridCampeonatos: document.getElementById('grid-campeonatos'),
            modalJogador: document.getElementById('modal-jogador'), modalVerJogador: document.getElementById('modal-ver-jogador'), modalCampeonato: document.getElementById('modal-campeonato'),
            modalVerCampeonato: document.getElementById('modal-ver-campeonato'), modalBackdrop: document.getElementById('modal-backdrop'), formJogador: document.getElementById('form-jogador'),
            formCampeonato: document.getElementById('form-campeonato'), btnAbrirModalJogador: document.getElementById('btn-abrir-modal-jogador'),
            btnAbrirModalCampeonato: document.getElementById('btn-abrir-modal-campeonato'), fotoInput: document.getElementById('foto'), fotoPreview: document.getElementById('preview-foto'),
            navTabs: document.querySelector('.nav-tabs'), tabContents: document.querySelectorAll('.tab-content'), usersTableBody: document.getElementById('users-table-body'),
            modalEditUser: document.getElementById('modal-edit-user'), formEditUser: document.getElementById('form-edit-user'),
            btnShowLogin: document.getElementById('btn-show-login'), btnShowRegister: document.getElementById('btn-show-register'),
        };

        const utils = {
            formatDate: (dateStr) => { if (!dateStr) return 'N/A'; const [year, month, day] = dateStr.split('-'); return `${day}/${month}/${year}`; },
        };

        const UI = {
            updateAuthUI(user) {
                const loggedInElements = document.querySelectorAll('.logged-in-only');
                const loggedOutElements = document.querySelectorAll('.logged-out-only');
                const adminElements = document.querySelectorAll('.admin-only');
                if (user) {
                    loggedInElements.forEach(el => el.style.display = 'flex');
                    loggedOutElements.forEach(el => el.style.display = 'none');
                    if (state.userRole === 'admin') {
                        adminElements.forEach(el => el.style.display = el.matches('.nav-tab, .btn') ? 'inline-flex' : 'block');
                    } else {
                        adminElements.forEach(el => el.style.display = 'none');
                    }
                } else {
                    loggedInElements.forEach(el => el.style.display = 'none');
                    loggedOutElements.forEach(el => el.style.display = 'flex');
                    adminElements.forEach(el => el.style.display = 'none');
                }
                this.renderAllCards();
            },
            renderAllCards() { this.renderJogadores(); this.renderCampeonatos(); },
            renderJogadores() {
                elements.gridJogadores.innerHTML = '';
                state.jogadores.forEach(j => {
                    const card = document.createElement('div');
                    const isAdmin = state.userRole === 'admin';
                    card.className = `player-card card ${isAdmin ? 'admin-view' : ''}`;
                    card.dataset.id = j.id;
                    const fotoHTML = j.foto ? `<img src="${j.foto}" alt="${j.nome}">` : `<div class="photo-placeholder">üèÄ</div>`;
                    const actionsHTML = isAdmin ? `<div class="card-actions"><button class="btn-edit-jogador" title="Editar">‚úèÔ∏è</button><button class="btn-delete-jogador" title="Excluir">üóëÔ∏è</button></div>` : '';
                    card.innerHTML = `${actionsHTML}<div class="photo-container">${fotoHTML}</div><p class="player-name">${j.nome}</p>`;
                    elements.gridJogadores.appendChild(card);
                });
            },
            renderCampeonatos() {
                elements.gridCampeonatos.innerHTML = '';
                state.campeonatos.forEach(c => {
                    const card = document.createElement('div');
                    const isAdmin = state.userRole === 'admin';
                    card.className = `championship-card card ${isAdmin ? 'admin-view' : ''}`;
                    card.dataset.id = c.id;
                    const actionsHTML = isAdmin ? `<div class="card-actions"><button class="btn-edit-camp" title="Editar">‚úèÔ∏è</button><button class="btn-delete-camp" title="Excluir">üóëÔ∏è</button></div>` : '';
                    card.innerHTML = `${actionsHTML}<div><h3 class="championship-name">${c.nome}</h3><div class="championship-info"><p>üìÖ <strong>Data:</strong> ${utils.formatDate(c.data)}</p><p>üë• <strong>Jogadores:</strong> ${c.jogadoresEscalados?.length || 0} escalado(s)</p></div></div>`;
                    elements.gridCampeonatos.appendChild(card);
                });
            },
            showFichaJogador(id) {
                const j = state.jogadores.find(p => p.id === id);
                if (!j) return;
                const fotoHTML = j.foto ? `<img src="${j.foto}" alt="${j.nome}">` : '<div class="placeholder">üèÄ</div>';
                let detailsHTML = `<p><strong>Nome:</strong> ${j.nome}</p><p><strong>Posi√ß√£o:</strong> ${j.posicao}</p><p><strong>N¬∫ Uniforme:</strong> ${j.numero_uniforme}</p>`;
                if (state.userRole === 'admin') {
                    detailsHTML += `<p><strong>CPF:</strong> ${j.cpf}</p><p><strong>Nascimento:</strong> ${utils.formatDate(j.nascimento)}</p>`;
                }
                elements.modalVerJogador.querySelector('#ficha-jogador').innerHTML = `${fotoHTML}<div>${detailsHTML}</div>`;
                this.openModal(elements.modalVerJogador);
            },
            showAuthModal(type) { if (type === 'login') { elements.registerContainer.classList.remove('active'); elements.loginContainer.classList.add('active'); } else { elements.loginContainer.classList.remove('active'); elements.registerContainer.classList.add('active'); } },
            closeAuthModals() { elements.loginContainer.classList.remove('active'); elements.registerContainer.classList.remove('active'); },
            openModal(modal) { elements.body.classList.add('modal-open'); elements.modalBackdrop.classList.add('active'); modal.classList.add('active'); },
            closeAllModals() { document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active')); this.closeAuthModals(); elements.modalBackdrop.classList.remove('active'); elements.body.classList.remove('modal-open'); },
            showCampeonatoModal(id = null) { if (state.userRole !== 'admin') return; elements.formCampeonato.reset(); let escalados = []; document.getElementById('campeonato-id').value = id || ''; if (id) { const c = state.campeonatos.find(i => i.id === id); if (!c) return; document.getElementById('modal-campeonato-titulo').innerText = 'Editar Campeonato'; document.getElementById('campeonato-nome').value = c.nome; document.getElementById('campeonato-data').value = c.data; escalados = c.jogadoresEscalados || []; } else { document.getElementById('modal-campeonato-titulo').innerText = 'Adicionar Novo Campeonato'; } const listaContainer = document.getElementById('lista-jogadores-escalar'); listaContainer.innerHTML = ''; const sortedJogadores = [...state.jogadores].sort((a, b) => a.nome.localeCompare(b.nome)); sortedJogadores.forEach(j => { const checked = escalados.includes(j.id) ? 'checked' : ''; listaContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" id="j_${j.id}" value="${j.id}" ${checked}><span>${j.nome} (#${j.numero_uniforme})</span></label>`; }); this.openModal(elements.modalCampeonato); },
            renderAllUsers() { if (state.userRole !== 'admin') { elements.usersTableBody.innerHTML = ''; return; } elements.usersTableBody.innerHTML = ''; state.allUsers.forEach(user => { const tr = document.createElement('tr'); const isCurrentUser = user.uid === state.currentUser.uid; const roleButton = isCurrentUser ? `<button class="role-toggle ${user.role}" disabled title="N√£o √© poss√≠vel alterar sua pr√≥pria permiss√£o">${user.role}</button>` : `<button class="role-toggle ${user.role}" data-uid="${user.uid}">${user.role}</button>`; const statusText = user.status === 'banned' ? '<span class="user-status banned">Banido</span>' : '<span class="user-status">Ativo</span>'; const banButton = user.status === 'banned' ? `<button class="action-btn btn-unban" title="Reativar" data-uid="${user.uid}">‚ôªÔ∏è</button>` : `<button class="action-btn btn-ban" title="Banir" data-uid="${user.uid}">üö´</button>`; const actions = isCurrentUser ? '' : `<div class="user-actions"><button class="action-btn btn-edit-user" title="Editar Dados" data-uid="${user.uid}">‚úèÔ∏è</button>${banButton}<button class="action-btn btn-delete" title="Excluir Conta" data-uid="${user.uid}">üóëÔ∏è</button></div>`; tr.innerHTML = `<td>${user.email}</td><td>${user.nome || 'N/A'}</td><td>${statusText}</td><td>${roleButton}</td><td>${actions}</td>`; elements.usersTableBody.appendChild(tr); }); },
            showEditUserModal(uid) { const user = state.allUsers.find(u => u.uid === uid); if (!user) return; elements.formEditUser['edit-user-id'].value = uid; elements.formEditUser['edit-user-nome'].value = user.nome; elements.formEditUser['edit-user-apelido'].value = user.apelido; elements.formEditUser['edit-user-nascimento'].value = user.dataNascimento; this.openModal(elements.modalEditUser); },
            showJogadorModal(id = null) { if (state.userRole !== 'admin') return; elements.formJogador.reset(); elements.fotoPreview.src = ''; elements.fotoPreview.classList.remove('visible'); document.getElementById('documento-id').value = id || ''; if (id) { const j = state.jogadores.find(p => p.id === id); if (!j) return; document.getElementById('modal-jogador-titulo').innerText = 'Editar Jogador'; document.getElementById('nome').value = j.nome; document.getElementById('cpf').value = j.cpf; document.getElementById('nascimento').value = j.nascimento; document.getElementById('posicao').value = j.posicao; document.getElementById('numero_uniforme').value = j.numero_uniforme; if(j.foto) { elements.fotoPreview.src = j.foto; elements.fotoPreview.classList.add('visible'); } } else { document.getElementById('modal-jogador-titulo').innerText = 'Cadastrar Novo Jogador'; } this.openModal(elements.modalJogador); },
            showFichaCampeonato(id) { const camp = state.campeonatos.find(c => c.id === id); if (!camp) return; document.getElementById('ver-campeonato-titulo').innerText = camp.nome; document.getElementById('ver-campeonato-data').innerText = `Data: ${utils.formatDate(camp.data)}`; const container = document.getElementById('escalacao-container'); container.innerHTML = ''; if (!camp.jogadoresEscalados || camp.jogadoresEscalados.length === 0) { container.innerHTML = '<p>Nenhum jogador escalado.</p>'; } else { camp.jogadoresEscalados.forEach(jogadorId => { const j = state.jogadores.find(p => p.id === jogadorId); if (j) { const fotoHTML = j.foto ? `<img src="${j.foto}" alt="${j.nome}">` : `<div class="placeholder">üèÄ</div>`; container.innerHTML += `<div class="jogador-escalado">${fotoHTML}<div class="info"><strong>${j.nome}</strong><br><span>#${j.numero_uniforme} - ${j.posicao}</span></div></div>`; } }); } this.openModal(elements.modalVerCampeonato); }
        };
        const dataService = {
            getUserProfile: async (uid) => { const docSnap = await getDoc(doc(db, "usuarios", uid)); return docSnap.exists() ? docSnap.data() : null; },
            deleteJogador: async (id) => { if (state.userRole !== 'admin') return; if (confirm('Tem certeza?')) { await deleteDoc(doc(db, "jogadores", id)); } },
            setUserRole: async (uid, newRole) => { if (state.userRole !== 'admin') return; await updateDoc(doc(db, "usuarios", uid), { role: newRole }); },
            setUserStatus: async (uid, newStatus) => { if (state.userRole !== 'admin') return; await updateDoc(doc(db, "usuarios", uid), { status: newStatus }); },
            updateUserData: async (uid, data) => { if (state.userRole !== 'admin') return; await updateDoc(doc(db, "usuarios", uid), data); },
            deleteUserCompletely: async (uid) => { if (state.userRole !== 'admin') return; try { await deleteDoc(doc(db, "usuarios", uid)); alert("Usu√°rio exclu√≠do."); } catch (error) { console.error(error); alert("Erro ao excluir."); } },
            saveCampeonato: async (id, dados) => { if (state.userRole !== 'admin') { alert("Acesso negado."); return; } if (id) { await updateDoc(doc(db, "campeonatos", id), dados); } else { await addDoc(collection(db, "campeonatos"), dados); } },
            deleteCampeonato: async (id) => { if (state.userRole !== 'admin') return; if (confirm('Tem certeza?')) { await deleteDoc(doc(db, "campeonatos", id)); } },
        };
        
        const handleLoginSubmit = async (e) => { e.preventDefault(); const email = elements.loginForm['login-email'].value; const password = elements.loginForm['login-password'].value; try { await signInWithEmailAndPassword(auth, email, password); UI.closeAuthModals(); elements.loginForm.reset(); } catch (error) { elements.loginError.textContent = "Email ou senha inv√°lidos."; elements.loginError.style.display = 'block'; } };
        const handleRegisterSubmit = async (e) => { e.preventDefault(); const { value: nome } = elements.registerForm['register-nome']; const { value: apelido } = elements.registerForm['register-apelido']; const { value: nascimento } = elements.registerForm['register-nascimento']; const { value: email } = elements.registerForm['register-email']; const { value: password } = elements.registerForm['register-password']; const { value: passwordConfirm } = elements.registerForm['register-password-confirm']; elements.registerError.style.display = 'none'; if (password !== passwordConfirm) { elements.registerError.textContent = "As senhas n√£o conferem."; elements.registerError.style.display = 'block'; return; } try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); await setDoc(doc(db, "usuarios", userCredential.user.uid), { nome, apelido, dataNascimento: nascimento, email, role: "jogador", status: "active" }); await signOut(auth); alert('Cadastro realizado com sucesso! Por favor, fa√ßa o login.'); elements.registerForm.reset(); UI.showAuthModal('login'); } catch (error) { let msg = "Ocorreu um erro."; if(error.code === 'auth/email-already-in-use') msg = "Este e-mail j√° est√° em uso."; else if (error.code === 'auth/weak-password') msg = "A senha √© muito fraca."; elements.registerError.textContent = msg; elements.registerError.style.display = 'block'; } };
        const handleJogadorFormSubmit = async (e) => { e.preventDefault(); /* ... */ };
        const handleCampeonatoFormSubmit = async(e) => { e.preventDefault(); /* ... */};
        const handleUsersTableClick = async (e) => { /* ... */ };
        const handleEditUserFormSubmit = async (e) => { /* ... */ };
        
        const addAppListeners = () => {
            elements.btnLogout.addEventListener('click', () => signOut(auth));
            document.querySelectorAll('.close-button').forEach(b => b.addEventListener('click', () => UI.closeAllModals()));
            elements.modalBackdrop.addEventListener('click', () => UI.closeAllModals());
            elements.navTabs.addEventListener('click', (e) => { if (!e.target.classList.contains('nav-tab')) return; const targetTab = e.target.dataset.tab; elements.navTabs.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); elements.tabContents.forEach(content => { content.classList.remove('active'); if (content.id === `tab-${targetTab}`) { content.classList.add('active'); } }); });
            elements.gridJogadores.addEventListener('click', (e) => { const card = e.target.closest('.player-card'); if (!card) return; const id = card.dataset.id; if (state.userRole === 'admin' && e.target.closest('.btn-edit-jogador')) { UI.showJogadorModal(id); } else if (state.userRole === 'admin' && e.target.closest('.btn-delete-jogador')) { dataService.deleteJogador(id); } else { UI.showFichaJogador(id); } });
            elements.gridCampeonatos.addEventListener('click', (e) => { const card = e.target.closest('.championship-card'); if (!card) return; const id = card.dataset.id; if (state.userRole === 'admin' && e.target.closest('.btn-edit-camp')) { UI.showCampeonatoModal(id); } else if (state.userRole === 'admin' && e.target.closest('.btn-delete-camp')) { dataService.deleteCampeonato(id); } else { UI.showFichaCampeonato(id); } });
        };
        
        function init() {
            elements.btnShowLogin.addEventListener('click', () => UI.showAuthModal('login'));
            elements.btnShowRegister.addEventListener('click', () => UI.showAuthModal('register'));
            elements.toggleToRegister.addEventListener('click', () => UI.showAuthModal('register'));
            elements.toggleToLogin.addEventListener('click', () => UI.showAuthModal('login'));
            elements.loginForm.addEventListener('submit', handleLoginSubmit);
            elements.registerForm.addEventListener('submit', handleRegisterSubmit);
            
            addAppListeners();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userProfile = await dataService.getUserProfile(user.uid);
                    if (userProfile && userProfile.status === 'banned') { signOut(auth); return; }
                    state.currentUser = user;
                    state.currentUserProfile = userProfile;
                    state.userRole = userProfile ? userProfile.role : null;
                    if (userProfile) { elements.welcomeMessage.textContent = `Bem vindo(a) ${userProfile.nome} (${userProfile.apelido})`; }
                } else {
                    state.currentUser = null;
                    state.currentUserProfile = null;
                    state.userRole = null;
                }
                UI.updateAuthUI(user);

                if (state.listeners.jogadoresUnsub) state.listeners.jogadoresUnsub();
                state.listeners.jogadoresUnsub = onSnapshot(query(collection(db, "jogadores"), orderBy("nome")), (snapshot) => { state.jogadores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); UI.renderJogadores(); });
                
                if (state.listeners.campeonatosUnsub) state.listeners.campeonatosUnsub();
                state.listeners.campeonatosUnsub = onSnapshot(query(collection(db, "campeonatos"), orderBy("data", "desc")), (snapshot) => { state.campeonatos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); UI.renderCampeonatos(); });

                if (state.userRole === 'admin' && !state.listeners.usersUnsub) {
                    state.listeners.usersUnsub = onSnapshot(query(collection(db, "usuarios"), orderBy("email")), (snapshot) => { state.allUsers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() })); UI.renderAllUsers(); });
                } else if (state.userRole !== 'admin' && state.listeners.usersUnsub) {
                    state.listeners.usersUnsub();
                    state.listeners.usersUnsub = null;
                }
            });
        }
        init();
    </script>
</body>
</html>